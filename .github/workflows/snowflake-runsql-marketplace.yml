name: Snowflake.RunSQLAction

on:
  workflow_dispatch:
    inputs:
      sql:
        description: 'SQL statement to execute via RunSQLAction'
        required: false
        default: "show grants to role ACCOUNTADMIN"
      return_rows:
        description: 'Maximum rows to return (1-1000)'
        required: false
        default: "10"
      persist_results:
        description: 'Persist full CSV results + metadata artifact (true/false)'
        required: false
        default: "false"
      result_filename:
        description: 'Base filename to use when persisting results (query id is appended)'
        required: false
        default: "snowflake-result.csv"

permissions:
  contents: read

jobs:
  runsql-action:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Snowflake.RunSQLAction
        id: runsql
        uses: marcelinojackson-org/Snowflake.RunSQLAction@v1.1.2
        with:
          sql: ${{ inputs.sql }}
          return-rows: ${{ inputs.return_rows }}
          persist-results: ${{ inputs.persist_results }}
          result-filename: ${{ inputs.result_filename }}
        env:
          SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD || secrets.SNOWFLAKE_PAT }}
          SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_LOG_LEVEL: MINIMAL

      - name: Upload Snowflake result artifact
        if: ${{ steps.runsql.outputs.result-file != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: snowflake-result
          path: |
            ${{ steps.runsql.outputs.result-file }}
            ${{ steps.runsql.outputs.result-metadata-file }}
