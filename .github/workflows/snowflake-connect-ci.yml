name: Snowflake.Actions-IntegrationTests

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  local-integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Snowflake.Testing
        uses: actions/checkout@v4

      - name: Checkout Snowflake.Common
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.Common
          path: deps/Snowflake.Common
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.RunSQLAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.RunSQLAction
          path: deps/Snowflake.RunSQLAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.CortexAI.SearchAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.CortexAI.SearchAction
          path: deps/Snowflake.CortexAI.SearchAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.CortexAI.AnalystAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.CortexAI.AnalystAction
          path: deps/Snowflake.CortexAI.AnalystAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.CortexAI.AgentAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.CortexAI.AgentAction
          path: deps/Snowflake.CortexAI.AgentAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Configure git auth for private deps
        run: |
          git config --global url."https://x-access-token:${{ secrets.SNOWFLAKE_GITHUB_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            deps/Snowflake.Common/package-lock.json
            deps/Snowflake.RunSQLAction/package-lock.json
            deps/Snowflake.CortexAI.SearchAction/package-lock.json
            deps/Snowflake.CortexAI.AnalystAction/package-lock.json
            deps/Snowflake.CortexAI.AgentAction/package-lock.json

      - name: Run local integration harness
        run: ./scripts/local-integration-test.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          RUNSQL_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.RunSQLAction
          SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD || secrets.SNOWFLAKE_PAT }}
          SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_LOG_LEVEL: MINIMAL

      - name: Run local Cortex Search harness
        run: ./scripts/local-cortex-search.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          CORTEX_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.CortexAI.SearchAction
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT || secrets.SNOWFLAKE_PASSWORD }}
          SEARCH_SERVICE: ${{ vars.SEARCH_SERVICE }}
          SEARCH_QUERY: ${{ vars.SEARCH_QUERY }}
          SEARCH_LIMIT: ${{ vars.SEARCH_LIMIT }}
          SEARCH_FILTER: ${{ vars.SEARCH_FILTER }}
          SEARCH_FIELDS: ${{ vars.SEARCH_FIELDS }}
          SEARCH_OFFSET: ${{ vars.SEARCH_OFFSET }}
          SEARCH_INCLUDE_SCORES: ${{ vars.SEARCH_INCLUDE_SCORES }}
          SEARCH_SCORE_THRESHOLD: ${{ vars.SEARCH_SCORE_THRESHOLD }}
          SEARCH_RERANKER: ${{ vars.SEARCH_RERANKER }}
          SEARCH_RANKING_PROFILE: ${{ vars.SEARCH_RANKING_PROFILE }}

      - name: Run local Cortex Analyst harness
        run: ./scripts/local-cortex-analyst.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          ANALYST_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.CortexAI.AnalystAction
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT || secrets.SNOWFLAKE_PASSWORD }}
          SEMANTIC_MODEL_PATH: ${{ vars.SEMANTIC_MODEL_PATH }}
          SEMANTIC_VIEW_PATH: ${{ vars.SEMANTIC_VIEW_PATH }}
          ANALYST_MESSAGE: ${{ vars.ANALYST_MESSAGE }}
          ANALYST_INCLUDE_SQL: ${{ vars.ANALYST_INCLUDE_SQL }}
          ANALYST_RESULT_FORMAT: ${{ vars.ANALYST_RESULT_FORMAT }}
          ANALYST_TEMPERATURE: ${{ vars.ANALYST_TEMPERATURE }}
          ANALYST_MAX_OUTPUT_TOKENS: ${{ vars.ANALYST_MAX_OUTPUT_TOKENS }}

      - name: Run local Cortex Agent harness
        run: ./scripts/local-cortex-agent.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          AGENT_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.CortexAI.AgentAction
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT || secrets.SNOWFLAKE_PASSWORD }}
          AGENT_DATABASE: ${{ vars.AGENT_DATABASE }}
          AGENT_SCHEMA: ${{ vars.AGENT_SCHEMA }}
          AGENT_NAME: ${{ vars.AGENT_NAME }}
          AGENT_MESSAGE: ${{ vars.AGENT_MESSAGE }}
          AGENT_THREAD_ID: ${{ vars.AGENT_THREAD_ID }}
          AGENT_PARENT_MESSAGE_ID: ${{ vars.AGENT_PARENT_MESSAGE_ID }}
          AGENT_TOOL_CHOICE: ${{ vars.AGENT_TOOL_CHOICE }}
