name: Snowflake Local Validation

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  local-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Snowflake.Testing
        uses: actions/checkout@v4

      - name: Checkout Snowflake.Common
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.Common
          path: deps/Snowflake.Common
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.RunSQLAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.RunSQLAction
          path: deps/Snowflake.RunSQLAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Configure git auth for private deps
        run: |
          git config --global url."https://x-access-token:${{ secrets.SNOWFLAKE_GITHUB_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            deps/Snowflake.Common/package-lock.json
            deps/Snowflake.RunSQLAction/package-lock.json

      - name: Run local integration harness
        run: ./scripts/local-integration-test.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          RUNSQL_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.RunSQLAction
          SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD || secrets.SNOWFLAKE_PAT }}
          SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_LOG_LEVEL: MINIMAL
