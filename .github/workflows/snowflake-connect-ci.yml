name: Snowflake.Actions-IntegrationTests

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  local-integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Snowflake.Testing
        uses: actions/checkout@v4

      - name: Checkout Snowflake.Common
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.Common
          path: deps/Snowflake.Common
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.RunSQLAction
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.RunSQLAction
          path: deps/Snowflake.RunSQLAction
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Checkout Snowflake.CortexAI.Search
        uses: actions/checkout@v4
        with:
          repository: marcelinojackson-org/Snowflake.CortexAI.Search
          path: deps/Snowflake.CortexAI.Search
          token: ${{ secrets.SNOWFLAKE_GITHUB_PAT }}

      - name: Configure git auth for private deps
        run: |
          git config --global url."https://x-access-token:${{ secrets.SNOWFLAKE_GITHUB_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            deps/Snowflake.Common/package-lock.json
            deps/Snowflake.RunSQLAction/package-lock.json
            deps/Snowflake.CortexAI.Search/package-lock.json

      - name: Run local integration harness
        run: ./scripts/local-integration-test.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          RUNSQL_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.RunSQLAction
          SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD || secrets.SNOWFLAKE_PAT }}
          SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_LOG_LEVEL: MINIMAL

      - name: Run local Cortex Search harness
        run: ./scripts/local-cortex-search.sh
        env:
          COMMON_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.Common
          CORTEX_REPO_DIR: ${{ github.workspace }}/deps/Snowflake.CortexAI.Search
          SNOWFLAKE_ACCOUNT_URL: ${{ vars.SNOWFLAKE_ACCOUNT_URL }}
          SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT || secrets.SNOWFLAKE_PASSWORD }}
          SEARCH_SERVICE: ${{ vars.SEARCH_SERVICE }}
          SEARCH_QUERY: ${{ vars.SEARCH_QUERY }}
          SEARCH_LIMIT: ${{ vars.SEARCH_LIMIT }}
          SEARCH_FILTER: ${{ vars.SEARCH_FILTER }}
          SEARCH_FIELDS: ${{ vars.SEARCH_FIELDS }}
          SEARCH_OFFSET: ${{ vars.SEARCH_OFFSET }}
          SEARCH_INCLUDE_SCORES: ${{ vars.SEARCH_INCLUDE_SCORES }}
          SEARCH_SCORE_THRESHOLD: ${{ vars.SEARCH_SCORE_THRESHOLD }}
          SEARCH_RERANKER: ${{ vars.SEARCH_RERANKER }}
          SEARCH_RANKING_PROFILE: ${{ vars.SEARCH_RANKING_PROFILE }}
